<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CPE 查榜小工具</title>
<style>
  body{font-family:Inter,sans-serif;background:#f9f9f9;margin:0;padding:24px;display:flex;justify-content:center}
  .container{max-width:980px;width:100%}
  .card{background:#fff;border-radius:12px;padding:28px;box-shadow:0 12px 36px rgba(0,0,0,0.05);position:relative;padding-bottom:96px}
  h1{margin:0 0 18px 0}
  .form{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:16px;align-items:center}
  .field{display:flex;flex-direction:column}
  label{font-size:12px;color:#666;margin-bottom:6px}
  input[type=text]{padding:8px;border:1px solid #bbb;border-radius:6px;min-width:150px;height:40px;box-sizing:border-box}
  .btn{height:40px;padding:0 14px;border-radius:10px;border:1px solid #bbb;background:#fff;cursor:pointer;font-weight:700;display:inline-flex;align-items:center;margin-left:auto}
  .results table{width:100%;border-collapse:collapse;font-size:14px;margin-top:16px}
  .results th, .results td{padding:10px 8px;text-align:left;border-bottom:1px solid #ccc}
  .empty{text-align:center;color:#666;padding:28px;background:#f5f5f5;border-radius:10px}
  .card .footer-credit{position:absolute;right:16px;bottom:12px;font-size:13px;color:#666;z-index:20}
  .card .footer-credit a{color:inherit;text-decoration:none}
  .card .footer-credit a strong{font-weight:800;color:#222}
  @media (max-width:520px){
    .btn{margin-left:0;width:100%;justify-content:center}
    .form{align-items:flex-start}
    .card{padding-bottom:120px} 
    .card .footer-credit{right:12px;left:12px;text-align:right}
  }
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>CPE 查榜小工具</h1>
    <div class="form">
      <div class="field">
        <label for="school">學校 / 單位（選填）</label>
        <input id="school" type="text" placeholder="例如：臺大資工">
      </div>
      <div class="field">
        <label for="name">姓名（必填，2~9 字）</label>
        <input id="name" type="text" placeholder="例如：王小明">
      </div>
      <button id="search" class="btn">查詢</button>
    </div>
    <div id="status">請輸入姓名並按查詢</div>
    <div class="results" id="results"><div class="empty">尚無查詢結果</div></div>

    <div class="footer-credit">
      <a href="https://github.com/slhs1121505/" target="_blank" rel="noopener noreferrer"><strong>張子夫</strong> 製作</a>
    </div>
  </div>
</div>

<script>
const DATES = [
  "2013-10-01","2013-12-17","2014-03-25","2014-05-27","2014-09-23","2014-12-23",
  "2015-03-24","2015-05-26","2015-10-06","2015-12-22","2016-03-22","2016-05-24",
  "2016-10-04","2016-12-20","2017-03-28","2017-05-23","2017-09-26","2017-12-19",
  "2018-03-27","2018-05-29","2018-10-02","2018-12-18","2019-03-26","2019-05-28",
  "2019-09-24","2019-12-17","2020-05-26","2020-06-09","2020-10-20","2020-12-22",
  "2021-03-23","2021-10-19","2021-12-21","2022-03-22","2022-05-24","2022-10-18",
  "2022-12-13","2023-03-21","2023-05-23","2023-10-17","2023-12-12","2024-04-23",
  "2024-05-21","2024-10-15","2024-12-10","2025-03-25","2025-05-20","2025-09-30"
];

const statusEl = document.getElementById('status');
const resultsEl = document.getElementById('results');

function anonymizeName(nameRaw){
  if(!nameRaw) return '';
  const name = [...nameRaw];
  const len = name.length;
  if(len === 2) return name[0] + 'Ｏ';
  if(len === 3) return name[0] + 'Ｏ' + name[2];
  if(len === 4) return name[0] + 'Ｏ' + name.slice(2).join('');
  if(len >= 5){ const mid=Math.floor(len/2); name[mid]='Ｏ'; return name.join('');}
  return nameRaw;
}

function validateName(n){ const l=n.trim().length; return l>1 && l<10; }

async function loadAll(){
  const promises = DATES.map(d=>fetch(`https://raw.githubusercontent.com/slhs1121505/CPE/main/data/${d}.json`).then(r=>r.ok?r.json().then(data=>({date:d,data:data})):Promise.reject(d)));
  const settled = await Promise.allSettled(promises);
  const loaded = settled.filter(s=>s.status==='fulfilled').map(s=>s.value);
  const failed = settled.filter(s=>s.status==='rejected').map(s=>s.reason);
  return {loaded,failed};
}

function render(matches){
  if(matches.length===0){resultsEl.innerHTML='<div class="empty">查無結果</div>'; return;}
  let html='<table><thead><tr><th>日期</th><th>排名</th><th>學校/單位</th><th>姓名</th><th>題數</th><th>分鐘</th><th>排名比例</th></tr></thead><tbody>';
  for(const r of matches){
    html+=`<tr>
      <td>${r.date||''}</td>
      <td>${r.rank||r['排名']||''}</td>
      <td>${r.school||r['學校']||''}</td>
      <td>${r.displayName||r.name||r['姓名']||''}</td>
      <td>${r.solved!==undefined?r.solved:r['題數']||0}</td>
      <td>${r.minutes!==undefined?r.minutes:r['分鐘']||0}</td>
      <td>${r.rankPercent||r['趴數']||''}</td>
    </tr>`;
  }
  html+='</tbody></table>';
  html+=`<div style="margin-top:10px;color:#666;font-size:13px">顯示 ${matches.length} 筆結果（日期由近到遠）</div>`;
  resultsEl.innerHTML=html;
}

document.getElementById('search').addEventListener('click',async function(){
  resultsEl.innerHTML=''; statusEl.textContent='';
  const school=document.getElementById('school').value.trim().toLowerCase();
  const nameInput=document.getElementById('name').value.trim();
  if(!validateName(nameInput)){statusEl.innerHTML='<span style="color:#b00">姓名長度不符：請輸入 2~9 字</span>'; return;}
  const anonName=anonymizeName(nameInput);
  statusEl.textContent='載入資料...';
  const data=await loadAll(); const loaded=data.loaded; const failed=data.failed;
  statusEl.textContent=failed.length>0?`完成載入（部分檔案找不到：${failed.length}）`:`完成載入（共 ${loaded.length} 個檔案）`;

  const matches=[];
  for(const entry of loaded){
    const date=entry.date;
    const arr=Array.isArray(entry.data)?entry.data:[];
    for(const row of arr){
      const rowName=row.name||row['姓名']||'';
      const rowSchool=(row.school||row['學校']||row.unit||row['單位']||'').toLowerCase();
      if(rowName===anonName && (school===''||rowSchool.indexOf(school)!==-1)){
        matches.push({
          ...row,
          date: date,
          displayName: rowName,
          rankPercent: row['趴數']||''
        });
      }
    }
  }

  matches.sort((a,b)=>{
    const da=new Date(a.date).getTime(), db=new Date(b.date).getTime();
    if(db!==da) return db-da;
    const ra=Number(a.rank||a['排名']||Infinity), rb=Number(b.rank||b['排名']||Infinity);
    return ra-rb;
  });

  render(matches);
});
</script>
</body>
</html>
